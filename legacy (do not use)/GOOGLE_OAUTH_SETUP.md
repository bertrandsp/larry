# Google OAuth Setup for Larry

This guide walks you through setting up Google OAuth for the Larry mobile app.

## 🎯 Overview

We're using `expo-auth-session` for Google OAuth, which provides:
- ✅ Works with Expo Go (no native modules needed)
- ✅ Standard OAuth 2.0 flow
- ✅ Secure token exchange
- ✅ Cross-platform support

## 📋 Setup Steps

### 1. Google Cloud Console Setup

1. **Go to [Google Cloud Console](https://console.cloud.google.com/)**

2. **Create a new project** (or select existing):
   - Project name: `Larry Vocabulary App`
   - Note the Project ID

3. **Enable Google+ API**:
   - Go to "APIs & Services" > "Library"
   - Search for "Google+ API" 
   - Click "Enable"

4. **Create OAuth 2.0 Credentials**:
   - Go to "APIs & Services" > "Credentials"
   - Click "Create Credentials" > "OAuth 2.0 Client IDs"

### 2. Configure OAuth Clients

#### **iOS Client**
1. **Application type**: iOS
2. **Name**: `Larry iOS`
3. **Bundle ID**: `co.hihi.larry` (from app.config.ts)
4. **App Store ID**: Leave blank for now
5. **Save and copy the Client ID**

#### **Android Client**
1. **Application type**: Android
2. **Name**: `Larry Android`
3. **Package name**: `co.hihi.larry` (from app.config.ts)
4. **SHA-1 certificate fingerprint**: 
   - For development: Get from `expo credentials:manager`
   - For production: Get from your signing certificate
5. **Save and copy the Client ID**

### 3. Configure Environment Variables

1. **Copy the example file**:
   ```bash
   cp app/env.example app/.env
   ```

2. **Update with your Client IDs**:
   ```bash
   # iOS Client ID from Google Console
   GOOGLE_CLIENT_ID_IOS=123456789-abcdefg.apps.googleusercontent.com
   
   # Android Client ID from Google Console
   GOOGLE_CLIENT_ID_ANDROID=123456789-hijklmnop.apps.googleusercontent.com
   
   # Backend API
   API_BASE_URL=http://localhost:4000
   
   # Email links
   EMAIL_LINK_HOST=https://larry.app/auth
   ```

### 4. Test the Implementation

1. **Start the app**:
   ```bash
   cd app
   npx expo start
   ```

2. **Test Google Sign-In**:
   - Open the app in Expo Go
   - Navigate to the onboarding screen
   - Click "Continue with Google"
   - Should open browser for OAuth flow
   - After authentication, should redirect back to app

## 🔧 Development Notes

### **Redirect URI Handling**
The app uses `larry://auth` as the redirect URI. This is automatically generated by:
```typescript
const redirectUri = AuthSession.makeRedirectUri({
  scheme: 'larry',
  path: 'auth',
});
```

### **Platform-Specific Client IDs**
The implementation automatically selects the correct client ID:
```typescript
const clientId = Platform.OS === 'ios' 
  ? config.googleClientIdIOS 
  : config.googleClientIdAndroid;
```

### **Token Exchange Flow**
1. User clicks "Continue with Google"
2. App opens browser with Google OAuth URL
3. User authenticates with Google
4. Google redirects to `larry://auth?code=...`
5. App exchanges authorization code for access token
6. App fetches user info from Google APIs
7. App sends tokens + user info to backend
8. Backend creates/updates user and returns JWT tokens

## 🚨 Security Considerations

1. **Client Secrets**: Mobile apps don't use client secrets (PKCE flow)
2. **Redirect URI**: Must match exactly what's configured in Google Console
3. **Token Validation**: Backend should verify tokens with Google
4. **Scopes**: Only request necessary scopes (`openid`, `profile`, `email`)

## 🐛 Common Issues

### "Invalid Client ID"
- Double-check the client ID matches Google Console
- Ensure you're using the correct client ID for the platform
- Verify the bundle ID/package name matches

### "Redirect URI Mismatch"
- Check that `larry://auth` is added to Google Console
- Ensure the scheme in app.config.ts matches

### "App Not Verified"
- For testing, Google will show a warning screen
- Users can click "Advanced" > "Go to Larry (unsafe)"
- For production, submit for Google verification

## 📱 Testing

### **In Expo Go**
- OAuth flow opens in system browser
- After auth, redirects back to Expo Go
- Check console logs for detailed flow tracking

### **In Production Build**
- OAuth flow opens in in-app browser
- Smoother user experience
- Same redirect flow

## 🔄 Refresh Tokens

The implementation requests offline access to get refresh tokens:
```typescript
extraParams: {
  access_type: 'offline', // Get refresh token
}
```

This allows the app to refresh expired access tokens without re-authentication.

---

## 🎉 You're Done!

Once you have the Client IDs configured, Google Sign-In should work seamlessly with the existing authentication flow. The implementation handles all the OAuth complexity automatically.
